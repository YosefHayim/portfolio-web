name: PR Tests

on:
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if tests exist
        id: check-tests
        run: |
          # Check for test scripts in root, client, or server
          HAS_TESTS=false
          
          for dir in . client server; do
            if [ -f "$dir/package.json" ]; then
              if grep -q '"test"' "$dir/package.json" && ! grep -q '"test": "echo' "$dir/package.json"; then
                HAS_TESTS=true
                break
              fi
            fi
          done
          
          echo "has_tests=$HAS_TESTS" >> $GITHUB_OUTPUT
          
          if [ "$HAS_TESTS" = "false" ]; then
            echo "No test script found in root, client, or server. Skipping tests."
          fi

      - name: Setup Node.js
        if: steps.check-tests.outputs.has_tests == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install and test root
        if: steps.check-tests.outputs.has_tests == 'true' && hashFiles('package.json') != ''
        run: |
          npm ci
          if grep -q '"test"' package.json && ! grep -q '"test": "echo' package.json; then
            npm test
          fi

      - name: Install and test client
        if: steps.check-tests.outputs.has_tests == 'true' && hashFiles('client/package.json') != ''
        working-directory: client
        run: |
          npm ci
          if grep -q '"test"' package.json && ! grep -q '"test": "echo' package.json; then
            npm test
          fi

      - name: Install and test server
        if: steps.check-tests.outputs.has_tests == 'true' && hashFiles('server/package.json') != ''
        working-directory: server
        run: |
          npm ci
          if grep -q '"test"' package.json && ! grep -q '"test": "echo' package.json; then
            npm test
          fi
